<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Панель управления</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; margin: 0; padding: 20px; }
        .container { max-width: 1300px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        #login-view { max-width: 400px; margin: 50px auto; text-align: center; }
        input, select { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { padding: 10px 15px; background: #0d6efd; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: #0b5ed7; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #bb2d3b; }
        .btn-edit { background: #ffc107; color: #000; }
        .btn-edit:hover { background: #ffca2c; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-btn { background: #e9ecef; color: #333; }
        .nav-btn.active { background: #0d6efd; color: white; }
        .hidden { display: none !important; }

        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .close { font-size: 24px; cursor: pointer; }
        
        .status-scheduled { color: #6c757d; }
        .status-check_in { color: #fd7e14; font-weight: bold; }
        .status-boarding { color: #d63384; font-weight: bold; }
        .status-departed { color: #0d6efd; }
        .status-arrived { color: #198754; }
        .status-delayed { color: #dc3545; font-weight: bold; }
        .status-cancelled { color: #212529; text-decoration: line-through; }
    </style>
</head>
<body>

<div id="login-view">
    <h2>Вход в систему</h2>
    <div id="login-error" style="color:red; display:none; margin-bottom:10px;">Ошибка входа</div>
    <input type="text" id="username" placeholder="Логин">
    <input type="password" id="password" placeholder="Пароль">
    <button onclick="login()" style="width:100%">Войти</button>
    <a href="/" style="display:block; margin-top:20px; color:#666; text-align:center;">Вернуться на табло</a>
</div>

<div id="dashboard-view" class="container hidden">
    <div class="header">
        <h2 id="welcome-msg">Панель управления</h2>
        <button class="btn-danger" onclick="logout()">Выход</button>
    </div>

    <div class="nav-tabs">
        <button class="nav-btn active" onclick="showTab('flights')">Рейсы</button>
        <button id="users-tab-btn" class="nav-btn hidden" onclick="showTab('users')">Персонал</button>
        <button id="audit-tab-btn" class="nav-btn hidden" onclick="showTab('audit')">Аудит</button>
    </div>

    <div id="flights-tab">
        <div style="margin-bottom: 15px;">
            <button id="add-flight-btn" class="hidden" onclick="openModal()">+ Добавить рейс</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Рейс</th>
                    <th>Маршрут</th>
                    <th>Вылет</th>
                    <th>Прибытие</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="flights-body"></tbody>
        </table>
    </div>

    <div id="users-tab" class="hidden">
        <table>
            <thead><tr><th>ID</th><th>Логин</th><th>ФИО</th><th>Роль</th></tr></thead>
            <tbody id="users-body"></tbody>
        </table>
    </div>

    <div id="audit-tab" class="hidden">
        <table>
            <thead><tr><th>Время</th><th>Пользователь</th><th>Действие</th><th>Детали</th></tr></thead>
            <tbody id="audit-body"></tbody>
        </table>
    </div>
</div>

<div id="flight-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">Создание рейса</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <input type="hidden" id="f-id">
        
        <label>Номер рейса</label>
        <input type="text" id="f-number" placeholder="SU-100">

        <label>Откуда</label>
        <select id="f-origin"></select>

        <label>Куда</label>
        <select id="f-dest"></select>

        <label>Время вылета</label>
        <input type="datetime-local" id="f-dep">

        <label>Время прибытия</label>
        <input type="datetime-local" id="f-arr">

        <label>Статус</label>
        <select id="f-status">
            <option value="scheduled">По расписанию</option>
            <option value="check_in">Регистрация</option>
            <option value="boarding">Посадка</option>
            <option value="departed">Вылетел</option>
            <option value="arrived">Прибыл</option>
            <option value="delayed">Задержан</option>
            <option value="cancelled">Отменен</option>
        </select>

        <label>Выход (Gate)</label>
        <input type="text" id="f-gate" placeholder="B12">

        <label>Самолет</label>
        <select id="f-aircraft"></select>

        <label>Командир</label>
        <select id="f-pilot"></select>

        <label>Второй пилот</label>
        <select id="f-copilot"></select>

        <button onclick="saveFlight()" style="width:100%; margin-top:10px;">Сохранить</button>
    </div>
</div>

<script>
    const API_URL = '/api';
    let resources = { airports: [], aircrafts: [], pilots: [] };
    let currentFlights = [];

    function checkAuth() {
        const token = localStorage.getItem('token');
        if (token) showDashboard();
        else {
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
        }
    }

    async function login() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        try {
            const res = await fetch(`${API_URL}/login`, {
                method: 'POST', body: JSON.stringify({ username: u, password: p }),
                headers: { 'Content-Type': 'application/json' }
            });
            if (res.ok) {
                const d = await res.json();
                localStorage.setItem('token', d.token);
                localStorage.setItem('role', d.role);
                localStorage.setItem('name', d.full_name);
                showDashboard();
            } else document.getElementById('login-error').style.display = 'block';
        } catch { alert('Ошибка сети'); }
    }

    function logout() { localStorage.clear(); location.reload(); }

    function showDashboard() {
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('dashboard-view').classList.remove('hidden');
        document.getElementById('welcome-msg').innerText = `Панель: ${localStorage.getItem('name')}`;

        const role = localStorage.getItem('role');
        if (role === 'admin') {
            document.getElementById('users-tab-btn').classList.remove('hidden');
            document.getElementById('audit-tab-btn').classList.remove('hidden');
            document.getElementById('add-flight-btn').classList.remove('hidden');
        }
        
        loadResources().then(() => loadPrivateFlights());
    }

    async function loadResources() {
        const res = await fetch(`${API_URL}/admin/resources`, { headers: { 'Authorization': localStorage.getItem('token') } });
        resources = await res.json();
        
        populateSelect('f-origin', resources.airports);
        populateSelect('f-dest', resources.airports);
        populateSelect('f-aircraft', resources.aircrafts, true);
        populateSelect('f-pilot', resources.pilots, true);
        populateSelect('f-copilot', resources.pilots, true);
    }

    function populateSelect(id, items, hasEmpty = false) {
        const sel = document.getElementById(id);
        sel.innerHTML = hasEmpty ? '<option value="0">-- Не выбран --</option>' : '';
        items.forEach(i => sel.innerHTML += `<option value="${i.id}">${i.name}</option>`);
    }

    async function loadPrivateFlights() {
        const res = await fetch(`${API_URL}/admin/flights`, { headers: { 'Authorization': localStorage.getItem('token') } });
        if (res.status === 403) return logout();
        
        const data = await res.json();
        currentFlights = data.flights;
        const tbody = document.getElementById('flights-body');
        tbody.innerHTML = '';
        const role = localStorage.getItem('role');

        data.flights.forEach(f => {
            let actions = `<button class="btn-edit" onclick="openModal(${f.id})">Ред.</button>`;
            if (role === 'admin') {
                actions += ` <button class="btn-danger" onclick="deleteFlight(${f.id})">Удал.</button>`;
            }

            tbody.innerHTML += `
                <tr>
                    <td><b>${f.flight_number}</b></td>
                    <td>${f.origin} -> ${f.destination}</td>
                    <td>${f.dep_time}</td>
                    <td>${f.arr_time}</td>
                    <td><span class="status-${f.status}">${translateStatus(f.status)}</span></td>
                    <td>${actions}</td>
                </tr>`;
        });
    }

    async function loadUsers() {
        const res = await fetch(`${API_URL}/admin/users`, { headers: { 'Authorization': localStorage.getItem('token') } });
        const data = await res.json();
        const tbody = document.getElementById('users-body');
        tbody.innerHTML = '';
        data.users.forEach(u => tbody.innerHTML += `<tr><td>${u.id}</td><td>${u.username}</td><td>${u.last_name} ${u.first_name}</td><td>${translateRole(u.role)}</td></tr>`);
    }

    async function loadAudit() {
        const res = await fetch(`${API_URL}/admin/audit`, { headers: { 'Authorization': localStorage.getItem('token') } });
        const data = await res.json();
        const tbody = document.getElementById('audit-body');
        tbody.innerHTML = '';
        data.logs.forEach(l => {
            let msg = l.details;
            try { msg = JSON.parse(l.details).message || msg; } catch{}
            tbody.innerHTML += `<tr><td>${l.time}</td><td>${l.user}</td><td>${l.action}</td><td>${msg}</td></tr>`;
        });
    }

    function showTab(t) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        ['flights', 'users', 'audit'].forEach(id => document.getElementById(id + '-tab').classList.add('hidden'));
        document.getElementById(t + '-tab').classList.remove('hidden');
        if (t === 'flights') loadPrivateFlights();
        if (t === 'users') loadUsers();
        if (t === 'audit') loadAudit();
    }

    function openModal(id = null) {
        document.getElementById('flight-modal').classList.remove('hidden');
        if (!id) {
            document.getElementById('modal-title').innerText = 'Создание рейса';
            document.getElementById('f-id').value = '';
            document.getElementById('f-number').value = '';
            document.getElementById('f-gate').value = '';
            document.getElementById('f-status').value = 'scheduled';
            document.getElementById('f-aircraft').value = 0;
            document.getElementById('f-pilot').value = 0;
            document.getElementById('f-copilot').value = 0;
        } else {
            const f = currentFlights.find(x => x.id === id);
            document.getElementById('modal-title').innerText = 'Редактирование рейса';
            document.getElementById('f-id').value = f.id;
            document.getElementById('f-number').value = f.flight_number;
            
            document.getElementById('f-status').value = f.status;
            document.getElementById('f-gate').value = f.gate;
        }
    }

    function closeModal() { document.getElementById('flight-modal').classList.add('hidden'); }

    async function saveFlight() {
        const id = document.getElementById('f-id').value;
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_URL}/admin/flights/${id}` : `${API_URL}/admin/flights`;

        const body = {
            flight_number: document.getElementById('f-number').value,
            origin: document.getElementById('f-origin').value,
            destination: document.getElementById('f-dest').value,
            dep_time: document.getElementById('f-dep').value,
            arr_time: document.getElementById('f-arr').value,
            status: document.getElementById('f-status').value,
            gate: document.getElementById('f-gate').value,
            aircraft_id: parseInt(document.getElementById('f-aircraft').value),
            pilot_id: parseInt(document.getElementById('f-pilot').value),
            copilot_id: parseInt(document.getElementById('f-copilot').value)
        };

        const res = await fetch(url, {
            method: method, body: JSON.stringify(body),
            headers: { 'Content-Type': 'application/json', 'Authorization': localStorage.getItem('token') }
        });

        if (res.ok) {
            closeModal();
            loadPrivateFlights();
        } else alert('Ошибка сохранения');
    }

    async function deleteFlight(id) {
        if (!confirm('Удалить рейс?')) return;
        const res = await fetch(`${API_URL}/admin/flights/${id}`, {
            method: 'DELETE', headers: { 'Authorization': localStorage.getItem('token') }
        });
        if (res.ok) loadPrivateFlights();
        else alert('Ошибка удаления');
    }

    function translateStatus(s) {
        const d = { 'scheduled': 'По расписанию', 'check_in': 'Регистрация', 'boarding': 'Посадка', 'departed': 'Вылетел', 'arrived': 'Прибыл', 'delayed': 'Задержан', 'cancelled': 'Отменен' };
        return d[s] || s;
    }
    function translateRole(r) { return r === 'admin' ? 'Админ' : 'Оператор'; }

    document.addEventListener('DOMContentLoaded', checkAuth);
</script>
</body>
</html>