<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Панель управления</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; margin: 0; padding: 20px; }
        .container { max-width: 1300px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        #login-view { max-width: 400px; margin: 50px auto; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #0d6efd; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background: #0b5ed7; }
        .error { color: red; margin-bottom: 10px; display: none; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .logout-btn { background: #dc3545; width: auto; padding: 8px 16px; font-size: 14px; }
        
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-btn { background: #e9ecef; color: #333; width: auto; padding: 10px 20px; border-radius: 4px; border:none; cursor: pointer; }
        .nav-btn.active { background: #0d6efd; color: white; }
        
        .hidden { display: none; }

        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; }
        
        .status-scheduled { color: #6c757d; }
        .status-check_in { color: #fd7e14; font-weight: bold; }
        .status-boarding { color: #d63384; font-weight: bold; }
        .status-departed { color: #0d6efd; }
        .status-arrived { color: #198754; }
        .status-delayed { color: #dc3545; font-weight: bold; }
        .status-cancelled { color: #212529; text-decoration: line-through; }
    </style>
</head>
<body>

<div id="login-view">
    <h2>Вход в систему</h2>
    <div id="login-error" class="error">Ошибка входа</div>
    <input type="text" id="username" placeholder="Логин">
    <input type="password" id="password" placeholder="Пароль">
    <button onclick="login()">Войти</button>
    <a href="/" style="display:block; margin-top:20px; color:#666;">Вернуться на табло</a>
</div>

<div id="dashboard-view" class="container hidden">
    <div class="header">
        <h2 id="welcome-msg">Панель оператора</h2>
        <button class="logout-btn" onclick="logout()">Выход</button>
    </div>

    <div class="nav-tabs">
        <button class="nav-btn active" onclick="showTab('flights')">Управление рейсами</button>
        <button id="users-tab-btn" class="nav-btn hidden" onclick="showTab('users')">Управление персоналом</button>
        <button id="audit-tab-btn" class="nav-btn hidden" onclick="showTab('audit')">Аудит системы</button>
    </div>

    <div id="flights-tab">
        <table>
            <thead>
                <tr>
                    <th>Рейс</th>
                    <th>Маршрут</th>
                    <th>Вылет</th>
                    <th>Прибытие</th> <th>Борт</th>
                    <th>Командир</th>
                    <th>Второй пилот</th>
                    <th>Пасс.</th>
                    <th>Статус</th>
                </tr>
            </thead>
            <tbody id="flights-body"></tbody>
        </table>
    </div>

    <div id="users-tab" class="hidden">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Логин</th>
                    <th>Фамилия</th>
                    <th>Имя</th>
                    <th>Отчество</th>
                    <th>Роль</th>
                </tr>
            </thead>
            <tbody id="users-body"></tbody>
        </table>
    </div>

    <div id="audit-tab" class="hidden">
        <table>
            <thead>
                <tr>
                    <th>Время</th>
                    <th>Пользователь</th>
                    <th>Действие</th>
                    <th>Таблица</th>
                    <th>Детали</th>
                </tr>
            </thead>
            <tbody id="audit-body"></tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = '/api';

    function checkAuth() {
        const token = localStorage.getItem('token');
        if (token) {
            showDashboard();
        } else {
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
        }
    }

    async function login() {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        try {
            const res = await fetch(`${API_URL}/login`, {
                method: 'POST', body: JSON.stringify({ username: user, password: pass }),
                headers: { 'Content-Type': 'application/json' }
            });
            if (res.ok) {
                const data = await res.json();
                localStorage.setItem('token', data.token);
                localStorage.setItem('role', data.role);
                localStorage.setItem('name', data.full_name);
                showDashboard();
            } else document.getElementById('login-error').style.display = 'block';
        } catch (e) { alert('Ошибка сети'); }
    }

    function logout() { localStorage.clear(); location.reload(); }

    function showDashboard() {
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('dashboard-view').classList.remove('hidden');
        document.getElementById('welcome-msg').innerText = `Добро пожаловать, ${localStorage.getItem('name')}`;

        if (localStorage.getItem('role') === 'admin') {
            document.getElementById('users-tab-btn').classList.remove('hidden');
            document.getElementById('audit-tab-btn').classList.remove('hidden');
        }
        loadPrivateFlights();
    }

    function showTab(tabName) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('flights-tab').classList.add('hidden');
        document.getElementById('users-tab').classList.add('hidden');
        document.getElementById('audit-tab').classList.add('hidden');
        document.getElementById(`${tabName}-tab`).classList.remove('hidden');

        if (tabName === 'flights') loadPrivateFlights();
        if (tabName === 'users') loadUsers();
        if (tabName === 'audit') loadAudit();
    }

    async function loadPrivateFlights() {
        const res = await fetch(`${API_URL}/admin/flights`, { headers: { 'Authorization': localStorage.getItem('token') } });
        if (res.status === 403) return logout();
        const data = await res.json();
        const tbody = document.getElementById('flights-body');
        tbody.innerHTML = '';
        data.flights.forEach(f => {
            tbody.innerHTML += `
                <tr>
                    <td><b>${f.flight_number}</b></td>
                    <td>${f.origin} -> ${f.destination}</td>
                    <td>${f.dep_time}</td>
                    <td>${f.arr_time}</td>
                    <td>${f.aircraft}</td>
                    <td>${f.pilot}</td>
                    <td>${f.copilot}</td>
                    <td>${f.passengers}</td>
                    <td><span class="status-${f.status}">${translateStatus(f.status)}</span></td>
                </tr>`;
        });
    }

    async function loadUsers() {
        const res = await fetch(`${API_URL}/admin/users`, { headers: { 'Authorization': localStorage.getItem('token') } });
        const data = await res.json();
        const tbody = document.getElementById('users-body');
        tbody.innerHTML = '';
        data.users.forEach(u => {
            tbody.innerHTML += `
                <tr>
                    <td>${u.id}</td>
                    <td><b>${u.username}</b></td>
                    <td>${u.last_name}</td>
                    <td>${u.first_name}</td>
                    <td>${u.middle_name}</td>
                    <td>${translateRole(u.role)}</td>
                </tr>`;
        });
    }

    async function loadAudit() {
        const res = await fetch(`${API_URL}/admin/audit`, { headers: { 'Authorization': localStorage.getItem('token') } });
        const data = await res.json();
        const tbody = document.getElementById('audit-body');
        tbody.innerHTML = '';
        data.logs.forEach(l => {
            let cleanMessage = l.details;
            try {
                const parsed = JSON.parse(l.details);
                if (parsed.message) cleanMessage = parsed.message;
                else if (parsed.info) cleanMessage = parsed.info;
            } catch (e) {
            }
            
            tbody.innerHTML += `
                <tr>
                    <td>${l.time}</td>
                    <td><b>${l.user}</b></td>
                    <td>${l.action}</td>
                    <td>${l.table}</td>
                    <td>${cleanMessage}</td>
                </tr>`;
        });
    }

    function translateStatus(s) {
        const d = { 'scheduled': 'По расписанию', 'check_in': 'Регистрация', 'boarding': 'Посадка', 'departed': 'Вылетел', 'arrived': 'Прибыл', 'delayed': 'Задержан', 'cancelled': 'Отменен' };
        return d[s] || s;
    }

    function translateRole(r) {
        return r === 'admin' ? 'Администратор' : (r === 'operator' ? 'Оператор' : r);
    }

    document.addEventListener('DOMContentLoaded', checkAuth);
</script>
</body>
</html>